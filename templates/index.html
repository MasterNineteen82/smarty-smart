{% extends "base.html" %}

{% block title %}Smart Card Manager - Dashboard{% endblock %}

{% block content %}
<div class="jumbotron">
    <h1 class="display-4">Welcome to Smart Card Manager!</h1>
    <p class="lead">This is a simple application for managing smart cards.</p>
    <hr class="my-4">
    <p>Use the navigation bar above to access the API Explorer, Configuration Manager, and Logs pages.</p>
    <a class="btn btn-primary btn-lg" href="/api_explorer" role="button">Explore APIs</a>
</div>

<div class="card-operations">
    <h2>Card Operations</h2>
    <div class="form-group">
        <label for="cardId">Card ID:</label>
        <input type="number" id="cardId" class="form-control" placeholder="Enter Card ID">
        <small id="cardIdHelp" class="form-text text-muted">Please enter a valid card ID.</small>
    </div>
    <button id="getCardInfo" class="btn btn-primary">Get Card Info</button>
    <div class="form-group">
        <label for="pin">PIN:</label>
        <input type="password" id="pin" class="form-control" placeholder="Enter PIN">
        <small id="pinHelp" class="form-text text-muted">Please enter your 4-digit PIN.</small>
    </div>
    <button id="authenticateCard" class="btn btn-success">Authenticate Card</button>
    <div id="output" class="mt-3">
        <!-- Output messages will be displayed here -->
    </div>
</div>

<script>
    $(document).ready(function() {
        // Function to display messages
        function displayMessage(message, type = 'danger') {
            $("#output").html(`<div class='alert alert-${type}'>${message}</div>`);
        }

        // Function to clear the output message
        function clearMessage() {
            $("#output").empty();
        }

        $("#getCardInfo").click(function() {
            clearMessage(); // Clear previous messages

            var cardId = $("#cardId").val();

            if (!cardId) {
                displayMessage("Please enter a Card ID.");
                return;
            }

            if (isNaN(cardId)) {
                displayMessage("Card ID must be a number.");
                return;
            }

            $.ajax({
                url: '/api/card/' + cardId,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    displayMessage("Card Info: " + JSON.stringify(data), 'success');
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("Error fetching card info:", jqXHR, textStatus, errorThrown);
                    displayMessage("Error: " + textStatus + " - " + errorThrown);
                }
            });
        });

        $("#authenticateCard").click(function() {
            clearMessage(); // Clear previous messages

            var cardId = $("#cardId").val();
            var pin = $("#pin").val();

            if (!cardId || !pin) {
                displayMessage("Please enter both Card ID and PIN.");
                return;
            }

            if (isNaN(cardId)) {
                displayMessage("Card ID must be a number.");
                return;
            }

            if (pin.length !== 4 || isNaN(pin)) {
                displayMessage("PIN must be a 4-digit number.");
                return;
            }

            $.ajax({
                url: '/api/card/authenticate',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({card_id: cardId, pin: pin}),
                dataType: 'json',
                success: function(data) {
                    if (data.success) {
                        displayMessage("Authentication Successful!", 'success');
                    } else {
                        displayMessage("Authentication Failed: " + data.message);
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("Error authenticating card:", jqXHR, textStatus, errorThrown);
                    displayMessage("Error: " + textStatus + " - " + errorThrown);
                }
            });
        });
    });
</script>
{% endblock %}