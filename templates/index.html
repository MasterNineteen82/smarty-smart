<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cherry Smart Terminal Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <!-- Add favicon -->
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/favicon.ico') }}">
</head>
<body>
    <header class="bg-dark text-white p-4">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1><i class="bi bi-smartcard"></i> Smart Card Manager</h1>
                    <p class="mb-0">Comprehensive lifecycle management for smart cards and NFC/RFID tags</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <button class="btn btn-primary" id="add-card-btn">Add New Card</button>
                </div>
            </div>
        </div>
    </header>
    <main class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div id="card-list" class="list-group">
                    <!-- Cards will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </main>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Cherry Smart Terminal Manager</h1>

        <!-- Server Controls -->
        <div class="row mb-3">
            <div class="col-md-6">
                <button class="btn btn-success w-100" onclick="startServer()">Start Server</button>
            </div>
            <div class="col-md-6">
                <button class="btn btn-danger w-100" onclick="stopServer()">Stop Server</button>
            </div>
        </div>

        <!-- Card Lifecycle Management Tabs -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <!-- Tab navigation -->
                <ul class="nav nav-tabs card-header-tabs" id="lifecycleTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="connect-tab" data-bs-toggle="tab" data-bs-target="#connect" type="button" role="tab">
                            <i class="bi bi-link"></i> Connect
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button" role="tab">
                            <i class="bi bi-person-badge"></i> Register
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="lifecycle-tab" data-bs-toggle="tab" data-bs-target="#lifecycle" type="button" role="tab">
                            <i class="bi bi-arrow-repeat"></i> Lifecycle
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup" type="button" role="tab">
                            <i class="bi bi-cloud-arrow-up"></i> Backup
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="operations-tab" data-bs-toggle="tab" data-bs-target="#operations" type="button" role="tab">
                            <i class="bi bi-gear"></i> Operations
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tools-tab" data-bs-toggle="tab" data-bs-target="#tools" type="button" role="tab">
                            <i class="bi bi-tools"></i> Tools
                        </button>
                    </li>
                </ul>
                
                <!-- Configuration link (moved out of tab list) -->
                <div>
                    <a href="/config_manager" class="btn btn-outline-primary">
                        <i class="bi bi-gear-fill"></i> Configuration
                    </a>
                </div>
            </div>
            
            <div class="card-body">
                <div class="tab-content" id="lifecycleTabsContent">
                    <!-- Connect Tab -->
                    <div class="tab-pane fade show active" id="connect" role="tabpanel" aria-labelledby="connect-tab">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="reader-select" class="form-label">Select Reader</label>
                                <select id="reader-select" class="form-select">
                                    {% for reader in readers %}
                                        <option value="{{ reader }}">{{ reader }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">&nbsp;</label>
                                <button onclick="connectCard()" class="btn btn-primary d-block w-100">
                                    <i class="bi bi-link"></i> Connect Card
                                </button>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button onclick="checkCardCompatibility()" class="btn btn-outline-info">
                                <i class="bi bi-check-circle"></i> Check Card Compatibility
                            </button>
                        </div>
                    </div>
                    
                    <!-- Registration Tab -->
                    <div class="tab-pane fade" id="register" role="tabpanel" aria-labelledby="register-tab">
                        <div class="mb-3">
                            <label for="card-name" class="form-label">Card Name</label>
                            <input type="text" class="form-control" id="card-name" placeholder="Enter a name for this card">
                        </div>
                        <div class="mb-3">
                            <label for="user-id" class="form-label">User ID</label>
                            <input type="text" class="form-control" id="user-id" placeholder="Enter user identifier">
                        </div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <button class="btn btn-primary w-100" onclick="registerCard()">
                                    <i class="bi bi-plus-circle"></i> Register Card
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-secondary w-100" onclick="checkRegistration()">
                                    <i class="bi bi-question-circle"></i> Check Registration
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-danger w-100" onclick="unregisterCard()">
                                    <i class="bi bi-x-circle"></i> Unregister Card
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lifecycle Tab -->
                    <div class="tab-pane fade" id="lifecycle" role="tabpanel" aria-labelledby="lifecycle-tab">
                        <div class="row g-3 mb-3">
                            <div class="col-lg-3 col-md-6">
                                <button class="btn btn-success w-100 mb-2" onclick="activateCard()">
                                    <i class="bi bi-play-circle"></i> Activate Card
                                </button>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <button class="btn btn-warning w-100 mb-2" onclick="deactivateCard()">
                                    <i class="bi bi-pause-circle"></i> Deactivate Card
                                </button>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <button class="btn btn-danger w-100 mb-2" onclick="blockCard()">
                                    <i class="bi bi-lock-fill"></i> Block Card
                                </button>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <button class="btn btn-outline-primary w-100 mb-2" onclick="unblockCard()">
                                    <i class="bi bi-unlock"></i> Unblock Card
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-danger w-100" onclick="disposeCard()">
                                    <i class="bi bi-trash"></i> Dispose
                                </button>
                            </div>
                        </div>
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> 
                            <strong>Warning:</strong> Activation/deactivation affects card usage, while blocking is a security measure.
                        </div>
                    </div>
                    
                    <!-- Backup Tab -->
                    <div class="tab-pane fade" id="backup" role="tabpanel" aria-labelledby="backup-tab">
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary w-100" onclick="backupCard()">
                                    <i class="bi bi-save"></i> Create Backup
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-secondary w-100" onclick="listBackups()">
                                    <i class="bi bi-list"></i> List Backups
                                </button>
                            </div>
                        </div>
                        <div class="mt-3" id="backups-container">
                            <h5>Available Backups</h5>
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>ID</th>
                                            <th>Date</th>
                                            <th>Card Type</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="backups-list">
                                        <!-- Backups will be listed here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Operations Tab -->
                    <div class="tab-pane fade" id="operations" role="tabpanel" aria-labelledby="operations-tab">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header">Memory Operations</div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="memory-offset" class="form-label">Offset</label>
                                            <input type="number" class="form-control" id="memory-offset" value="0" min="0">
                                        </div>
                                        <div class="mb-3">
                                            <label for="memory-length" class="form-label">Length</label>
                                            <input type="number" class="form-control" id="memory-length" value="16" min="1" max="255">
                                        </div>
                                        <div class="mb-3">
                                            <label for="memory-data" class="form-label">Data (hex)</label>
                                            <input type="text" class="form-control" id="memory-data" placeholder="E.g. 0102030405">
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button onclick="readMemoryRegion()" class="btn btn-primary flex-grow-1">
                                                <i class="bi bi-file-earmark-text"></i> Read
                                            </button>
                                            <button onclick="writeMemory()" class="btn btn-warning flex-grow-1">
                                                <i class="bi bi-pencil-square"></i> Write
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header">PIN Management</div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="old-pin" class="form-label">Current PIN</label>
                                            <input type="password" class="form-control" id="old-pin">
                                        </div>
                                        <div class="mb-3">
                                            <label for="change-new-pin" class="form-label">New PIN</label>
                                            <input type="password" class="form-control" id="change-new-pin">
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button onclick="verifyPin()" class="btn btn-secondary flex-grow-1">
                                                <i class="bi bi-check"></i> Verify PIN
                                            </button>
                                            <button onclick="changePin()" class="btn btn-primary flex-grow-1">
                                                <i class="bi bi-key"></i> Change PIN
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tools Tab -->
                    <div class="tab-pane fade" id="tools" role="tabpanel" aria-labelledby="tools-tab">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <button class="btn btn-outline-danger w-100 mb-2" onclick="disposeCard()">
                                    <i class="bi bi-trash"></i> Securely Dispose Card
                                </button>
                                <div class="alert alert-danger mt-2">
                                    <strong>Warning:</strong> This will permanently erase all data on the card.
                                </div>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-secondary w-100 mb-2" onclick="getCardInfo()">
                                    <i class="bi bi-info-circle"></i> Card Info
                                </button>
                                <div class="d-grid gap-2 mt-2">
                                    <button class="btn btn-outline-warning btn-sm" onclick="toggleRecoveryMode(true)">
                                        <i class="bi bi-shield-lock"></i> Enable Recovery Mode
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="toggleRecoveryMode(false)">
                                        <i class="bi bi-shield-check"></i> Disable Recovery Mode
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle"></i>
                            Recovery mode bypasses state validation for admin operations.
                        </div>
                        <!-- Add this in the Tools tab, after the recovery mode buttons -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="bi bi-bug"></i> Testing</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="mb-2">Run application tests to verify system integrity.</p>
                                        <button class="btn btn-outline-primary" onclick="runTests()">
                                            <i class="bi bi-play-circle"></i> Run Tests
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="viewTestResults()">
                                            <i class="bi bi-file-text"></i> View Last Results
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Add this button in the Tools tab section -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="bi bi-bug"></i> System Tools</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row gy-3">
                                            <div class="col-md-6">
                                                <h6>Diagnostics</h6>
                                                <p class="mb-2">Troubleshoot and monitor system operation.</p>
                                                <div class="btn-group">
                                                    <button class="btn btn-outline-primary" onclick="runTests()">
                                                        <i class="bi bi-play-circle"></i> Run Tests
                                                    </button>
                                                    <a href="/logs" class="btn btn-outline-secondary">
                                                        <i class="bi bi-journal-code"></i> View Logs
                                                    </a>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Recovery Options</h6>
                                                <p class="mb-2">Advanced recovery tools for administrators.</p>
                                                <div class="btn-group">
                                                    <button class="btn btn-outline-warning" onclick="toggleRecoveryMode(true)">
                                                        <i class="bi bi-shield-exclamation"></i> Enable Recovery
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="toggleRecoveryMode(false)">
                                                        <i class="bi bi-shield-check"></i> Disable Recovery
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Add this card in your main dashboard grid, perhaps in the Tools or Settings section -->
                        <div class="col-md-4 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="bi bi-gear-fill"></i> Configuration</h5>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">Manage application settings, reader configurations, and advanced options.</p>
                                    <a href="/config_manager" class="btn btn-primary">
                                        <i class="bi bi-sliders"></i> Manage Configuration
                                    </a>
                                </div>
                            </div>
                        </div>
                        <!-- Update the Tools section to include configuration -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="bi bi-tools"></i> System Tools</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row gy-3">
                                            <div class="col-md-4">
                                                <h6>Diagnostics</h6>
                                                <p class="mb-2">Troubleshoot and monitor system operation.</p>
                                                <div class="d-grid gap-2">
                                                    <button class="btn btn-outline-primary" onclick="runTests()">
                                                        <i class="bi bi-play-circle"></i> Run Tests
                                                    </button>
                                                    <a href="/logs" class="btn btn-outline-secondary">
                                                        <i class="bi bi-journal-code"></i> View Logs
                                                    </a>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <h6>Configuration</h6>
                                                <p class="mb-2">Manage system settings and preferences.</p>
                                                <div class="d-grid gap-2">
                                                    <a href="/config_manager" class="btn btn-outline-primary">
                                                        <i class="bi bi-gear"></i> Settings
                                                    </a>
                                                    <a href="/api-explorer" class="btn btn-outline-secondary">
                                                        <i class="bi bi-code-slash"></i> API Explorer
                                                    </a>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <h6>Recovery Options</h6>
                                                <p class="mb-2">Advanced recovery tools for administrators.</p>
                                                <div class="btn-group w-100">
                                                    <button class="btn btn-outline-warning" onclick="toggleRecoveryMode(true)">
                                                        <i class="bi bi-shield-exclamation"></i> Enable Recovery
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="toggleRecoveryMode(false)">
                                                        <i class="bi bi-shield-check"></i> Disable Recovery
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Output Card -->
        <div class="card mt-4">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-terminal"></i> Results</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('output').textContent = ''">
                        <i class="bi bi-trash"></i> Clear
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="resultOutput" class="alert alert-info">
                    Ready to process commands.
                </div>
                <pre id="outputDetails" class="bg-light p-3 small d-none"></pre>
            </div>
            <div class="card-body">
                <div id="output" class="result-message p-3 bg-light rounded overflow-auto">
                    <em>No operations performed yet. Select an action from the tabs above.</em>
                </div>
            </div>
        </div>

        <!-- Add this footer section before closing the container div -->
        <footer class="mt-5 mb-3 text-center text-muted">
            <hr>
            <p class="mb-1"><small>Smart Card Manager v1.0</small></p>
            <p><small>Supports Cherry SmartTerminal ST and ACR122U with ISO 14443 Type A/B, MIFARE, FeliCa, and NFC Types 1-4</small></p>
        </footer>
    </div>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <!-- Add these before the closing </body> tag and after your script.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"></script>
    <!-- Add to mobile/collapsed menu if applicable -->
    <div class="dropdown-menu">
        <!-- Other menu items -->
        <a class="dropdown-item" href="/config_manager">
            <i class="bi bi-gear-fill"></i> Configuration
        </a>
    </div>
    <!-- Add this right before the closing </body> tag -->
    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script src="{{ url_for('static', filename='js/card_operations.js') }}"></script>
</body>
</html>